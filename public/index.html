<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cevenz Scat Beta 3.1</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
  :root{
    --bg:#111;
    --panel:#222;
    --border:#444;
    --text:#eee;
    --radius:12px;
    --font:'Inter',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:var(--font)}
  body{background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column}
  header{background:var(--panel);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;border-radius:0 0 var(--radius) var(--radius)}
  header h1{font-size:20px;font-weight:600}
  header button{margin-left:12px;padding:8px 16px;border:none;border-radius:var(--radius);background:var(--border);color:var(--text);cursor:pointer;font-size:14px;transition:.2s}
  header button:hover{background:#555}
  #auth,#chat{flex:1;display:flex;flex-direction:column;padding:20px}
  #auth{justify-content:center;align-items:center}
  #auth form{background:var(--panel);padding:40px;border-radius:var(--radius);width:100%;max-width:340px;display:flex;flex-direction:column;gap:16px}
  #auth input{padding:12px;border-radius:var(--radius);border:1px solid var(--border);background:#111;color:var(--text);font-size:15px}
  #auth button{padding:14px;border:none;border-radius:var(--radius);background:var(--border);color:var(--text);font-weight:600;cursor:pointer;font-size:16px;transition:.2s}
  #auth button:hover{background:#555}
  #chat{display:none;flex-direction:column}
  #messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
  .msg{background:var(--panel);padding:12px;border-radius:var(--radius);max-width:85%;word-break:break-word;cursor:pointer;transition:.2s}
  .msg:hover{background:#333}
  #form{display:flex;padding:12px;border-top:1px solid var(--border)}
  #form input{flex:1;padding:12px;border:none;border-radius:var(--radius) 0 0 var(--radius);background:#111;color:var(--text);font-size:15px}
  #form button{padding:12px 20px;border:none;border-radius:0 var(--radius) var(--radius) 0;background:var(--border);color:var(--text);cursor:pointer;font-size:16px;transition:.2s}
  #form button:hover{background:#555}
  #ctxMenu{position:fixed;background:#333;border:1px solid var(--border);border-radius:var(--radius);padding:6px 0;display:none;z-index:999}
  #ctxMenu div{padding:8px 16px;cursor:pointer;font-size:14px}
  #ctxMenu div:hover{background:#555}
</style>
</head>
<body>
<header>
  <h1>Cevenz Scat Beta 3.1</h1>
  <div>
    <button id="clearBtn">Отчистка</button>
    <button id="logoutBtn">Выйти</button>
  </div>
</header>

<!-- Регистрация -->
<div id="auth">
  <form id="regForm">
    <input required maxlength="30" placeholder="Имя" id="name">
    <input required maxlength="20" placeholder="Номер телефона" id="phone">
    <input required minlength="4" type="password" placeholder="Пароль" id="pass">
    <input required type="password" placeholder="Пароль для входа (09270473)" id="code">
    <button type="submit">Scat!</button>
  </form>
</div>

<!-- Чат -->
<div id="chat">
  <div id="messages"></div>
  <form id="form">
    <input required maxlength="2000" placeholder="Сообщение..." id="msgInput">
    <button type="submit">➤</button>
  </form>
</div>

<!-- Контекстное меню -->
<div id="ctxMenu">
  <div data-action="copy">Копировать</div>
  <div data-action="delete">Удалить</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const authForm = document.getElementById('regForm');
const authDiv  = document.getElementById('auth');
const chatDiv  = document.getElementById('chat');
const messages = document.getElementById('messages');
const msgForm  = document.getElementById('form');
const msgInput = document.getElementById('msgInput');
const ctxMenu  = document.getElementById('ctxMenu');

let user = null;

/* Авторизация */
function loadUser(){
  const u = localStorage.getItem('user');
  if(u){ user=JSON.parse(u); enterChat(); }
}
loadUser();

authForm.addEventListener('submit', e=>{
  e.preventDefault();
  const payload = {
    name:document.getElementById('name').value.trim(),
    phone:document.getElementById('phone').value.trim(),
    pass:document.getElementById('pass').value.trim(),
    code:document.getElementById('code').value.trim()
  };
  fetch('/api/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)})
    .then(r=>r.json()).then(u=>{ user=u; localStorage.setItem('user',JSON.stringify(u)); enterChat(); });
});

function enterChat(){
  authDiv.style.display='none';
  chatDiv.style.display='flex';
  socket.emit('getHistory');
}

/* Выход / очистка */
document.getElementById('logoutBtn').onclick = ()=>{ localStorage.removeItem('user'); location.reload(); };
document.getElementById('clearBtn').onclick  = ()=> socket.emit('clear');

/* Отправка сообщений */
msgForm.addEventListener('submit', e=>{
  e.preventDefault();
  const text = msgInput.value.trim();
  if(!text) return;
  socket.emit('send', {text,user});
  msgInput.value='';
});

/* Получение сообщений */
socket.on('history', list=> list.forEach(addMsg));
socket.on('newMessage', addMsg);
socket.on('messageDeleted', id=> document.querySelector(`[data-id="${id}"]`)?.remove());
socket.on('cleared', ()=> messages.innerHTML='');

function addMsg({id,user,text}){
  const div=document.createElement('div');
  div.className='msg'; div.dataset.id=id;
  div.innerHTML = `<strong>${user}</strong>: ${text}`;
  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;
}

/* Контекстное меню */
let currentId=null;
messages.addEventListener('contextmenu', e=>{
  e.preventDefault();
  const msg=e.target.closest('.msg');
  if(!msg) return;
  currentId=msg.dataset.id;
  ctxMenu.style.left=e.clientX+'px';
  ctxMenu.style.top=e.clientY+'px';
  ctxMenu.style.display='block';
});
document.addEventListener('click', ()=> ctxMenu.style.display='none');
ctxMenu.addEventListener('click', e=>{
  if(!currentId) return;
  const action=e.target.dataset.action;
  if(action==='copy') navigator.clipboard.writeText(document.querySelector(`[data-id="${currentId}"]`).innerText);
  if(action==='delete') socket.emit('delete', currentId);
  ctxMenu.style.display='none';
});
</script>
</body>
</html>
